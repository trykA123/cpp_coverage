name: Code Coverage

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

permissions:
  pull-requests: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: make deps

      - name: Build
        run: make build

      - name: Run tests
        run: ./main

      - name: Create coverage folder
        run: mkdir -p ${{ github.workspace }}/coverage

      - name: Generate Gcovr XML report
        run: gcovr --cobertura -o coverage.xml

      # - name: Cobertura Action
      #   uses: 5monkeys/cobertura-action@master
      #   if: success() || failure()
      #   with:
      #     path: ${{ github.workspace }}/coverage/coverage-gcovr.xml
      #     minimum_coverage: 35
      #     repo_token: ${{ secrets.COBERTURA_TOKEN }}

      # - name: Code Coverage Summary Report
      #   uses: irongut/CodeCoverageSummary@v1.3.0
      #   with:
      #     filename: coverage-gcovr.xml
      #     badge: true
      #     fail_below_min: true
      #     format: markdown
      #     hide_branch_rate: false
      #     hide_complexity: true
      #     indicators: true
      #     output: both
      #     thresholds: "50 80"

      # - name: Add Coverage PR Comment
      #   uses: marocchino/sticky-pull-request-comment@v2
      #   if: github.event_name == 'pull_request'
      #   with:
      #     recreate: true
      #     path: code-coverage-results.md

  upload_coverage_to_influxdb:
    needs: coverage
    runs-on: ubuntu-latest
    steps:
      - name: Download coverage report
        uses: actions/download-artifact@v3
        with:
          name: coverage-report

      - name: Extract coverage percentage
        id: get_coverage
        run: |
          LINE_RATE=$(grep -oP 'line-rate="\K[^"]*' coverage.xml | head -1)
          COVERAGE=$(echo "$LINE_RATE" | awk '{printf "%.2f", $1 * 100}')
          echo "Coverage: $COVERAGE%"
          echo "::set-output name=coverage::$COVERAGE"

      - name: Upload coverage to InfluxDB
        run: |
          curl -X POST "${{ secrets.INFLUXDB_URL }}/api/v2/write?org=${{ secrets.INFLUXDB_ORG }}&bucket=${{ secrets.INFLUXDB_BUCKET }}&precision=s" \
          -H "Authorization: Token ${{ secrets.INFLUXDB_TOKEN }}" \
          --data-raw "rust_code_coverage,repository=${GITHUB_REPOSITORY},branch=${{ github.ref_name }} coverage=${{ steps.get_coverage.outputs.coverage }}"
